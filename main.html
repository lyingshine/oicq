<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QQ2008</title>
    <link rel="stylesheet" href="vendor/fontawesome/all.min.css">
    <link rel="stylesheet" href="styles/style.css">
</head>
<body>
    <div class="title-bar">
        <span class="title">QQ2008</span>
        <div class="window-controls">
            <button id="minimize-btn" class="window-control">-</button>
            <button id="maximize-btn" class="window-control">□</button>
            <button id="close-btn" class="window-control">×</button>
        </div>
    </div>
    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-icons-container">
                <div class="sidebar-icon icon-penguin active" title="联系人"></div>
                <div class="sidebar-icon icon-qzone" title="QQ空间"></div>
                <div class="sidebar-icon icon-photo" title="相册"></div>
                <div class="sidebar-icon icon-file" title="文件"></div>
                <div class="sidebar-icon icon-yixin" title="易信"></div>
            </div>
            <div class="sidebar-scroll">
                <div class="scroll-up"></div>
                <div class="scroll-down"></div>
            </div>
        </div>
        <div class="main-panel">
            <div class="header">
                <div class="user-info-container">
                            <div class="avatar-container">
                <div class="avatar-wrapper">
                            <img src="assets/logo.png" alt="Avatar" class="main-avatar" id="main-avatar-img" onclick="showProfileCard()">
                    <div class="avatar-frame main-avatar-frame"></div>
                            <div class="status-icon online" id="status-icon" title="点击切换状态" onclick="toggleStatusMenu(event)"></div>
                </div>
            </div>
                <div class="user-details">
                    <div class="user-line-1">
                       <!-- 移除了在线状态指示器 -->
                           <span class="nickname">加载中...</span>
                           <span class="status-text">[在线]</span>
                   </div>
                    <!-- 已移除等级、邮件和金钱显示 -->
                    <div class="user-signature" title="点击修改个性签名">
                            <span id="signature-text">加载中...</span>
                        <span class="edit-signature-icon"></span>
                        </div>
                    </div>
                </div>
                <div class="status-weather-container">
                    <!-- 调试按钮 -->
                    <!-- 已移除查看资料按钮 -->
                </div>
            </div>
            <div class="search-bar">
                <div class="search-icon"></div>
                <input type="text" placeholder="搜索我的好友...">
                <div class="search-dropdown-icon"></div>
            </div>
            <div class="tab-header">
               <span>QQ好友</span>
               <span class="tab-header-options">
                   <span class="tab-option" title="刷新好友列表" id="refresh-friends-btn"><i class="fas fa-sync-alt"></i></span>
                   <span class="tab-option" title="添加分组">+</span>
                   <span class="tab-option" title="显示设置">≡</span>
               </span>
            </div>
            <div class="friend-list">
                <!-- Friend list generates here -->
            </div>
            <div class="bottom-tabs">
                <button class="tab-button active">通讯录</button>
                <button class="tab-button">QQ群</button>
                <button class="tab-button">最近联系人</button>
            </div>
            <div class="footer">
                <div class="footer-icons-left">
                    <span class="footer-icon icon-menu" id="main-menu-btn" title="主菜单"></span>
                    <span class="footer-icon icon-find-friend" id="add-friend-btn" title="查找好友">
                        <span class="notification-badge" id="friend-request-badge" style="display: none;">0</span>
                    </span>
                    <span class="footer-icon icon-tools" title="系统设置"></span>
                    <span class="footer-icon icon-message" title="消息管理"></span>
                    <span class="footer-icon icon-antivirus" title="安全中心"></span>
                </div>
            </div>

            <div class="main-menu-popup" id="main-menu-popup">
                <ul>
                    <li id="switch-account-btn"><i class="fas fa-exchange-alt"></i> 切换账号</li>
                    <li id="test-sound-btn"><i class="fas fa-volume-up"></i> 测试声音</li>
                    <li><i class="fas fa-sign-out-alt"></i> 退出登录</li>
                </ul>
            </div>
            
            <div class="status-menu-popup" id="status-menu-popup">
                <ul>
                    <li data-status="online"><span class="status-dot online"></span> 在线</li>
                    <li data-status="away"><span class="status-dot away"></span> 离开</li>
                    <li data-status="busy"><span class="status-dot busy"></span> 忙碌</li>
                    <li data-status="invisible"><span class="status-dot invisible"></span> 隐身</li>
                </ul>
            </div>
            
            <!-- 用户资料卡 -->
            <div class="profile-card" id="profile-card">
                <div class="profile-card-header">
                    <div class="profile-card-avatar">
                        <img src="assets/logo.png" alt="Avatar" id="profile-avatar">
                    </div>
                </div>
                <div class="profile-card-content">
                    <input type="text" class="edit-input" id="nickname-input" placeholder="输入昵称">
                    <div class="profile-card-name" id="profile-name">加载中...</div>
                    <div class="profile-card-qq">QQ: <span id="profile-qq">------</span></div>
                    
                    <input type="text" class="edit-input" id="signature-input" placeholder="输入个性签名">
                    <div class="profile-card-signature" id="profile-signature">加载中...</div>
                </div>
                <div class="profile-card-footer">
                    <button class="profile-card-cancel" id="profile-cancel">取消</button>
                    <button class="profile-card-save" id="profile-save" onclick="handleProfileSave()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局用户变量
        window.currentUser = null;
        let userInfoApplied = false; // 标记是否已应用用户信息
        
        // 状态菜单弹出函数
        function toggleStatusMenu(e) {
            e.stopPropagation(); // 阻止事件冒泡，防止触发头像点击事件
            console.log('点击状态图标');
            
            const statusIcon = document.getElementById('status-icon');
            const statusMenuPopup = document.getElementById('status-menu-popup');
            
            // 获取图标位置
            const rect = statusIcon.getBoundingClientRect();
            
            // 计算菜单位置 - 显示在状态图标右侧
            statusMenuPopup.style.top = (rect.top - 5) + 'px';
            statusMenuPopup.style.left = (rect.right + 5) + 'px';
            
            // 检查是否会超出窗口右侧边界
            if (rect.right + 5 + 120 > window.innerWidth) { // 120px是菜单宽度
                // 如果会超出右侧，改为显示在图标左侧
                statusMenuPopup.style.left = (rect.left - 125) + 'px';
            }
            
            // 显示或隐藏状态菜单
            statusMenuPopup.style.display = statusMenuPopup.style.display === 'block' ? 'none' : 'block';
        }

        // 尝试从本地存储恢复用户信息
        function tryLoadUserFromLocalStorage() {
            try {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    console.log('从本地存储恢复用户信息:', user);
                    window.currentUser = user;
                    
                    // 仅当未接收到服务器信息时才应用本地存储的信息
                    if (!userInfoApplied) {
                    applyUserInfoToUI(user);
                    return true;
                    }
                }
                
                // 尝试从rememberedUser获取信息
                const rememberedUserStr = localStorage.getItem('rememberedUser');
                if (rememberedUserStr && !userInfoApplied) {
                    const rememberedUser = JSON.parse(rememberedUserStr);
                    if (rememberedUser && rememberedUser.username) {
                        console.log('找到rememberedUser信息，尝试重新获取完整用户信息');
                        // 显示加载提示，但不执行其他操作
                        const nicknameEl = document.querySelector('.nickname');
                        if (nicknameEl) {
                            nicknameEl.textContent = '正在加载...';
                        }
                    }
                }
            } catch (error) {
                console.error('从本地存储恢复用户信息失败:', error);
            }
            return false;
        }
        
        // 辅助函数：将用户信息应用到UI界面
        function applyUserInfoToUI(user) {
            if (!user) return;
            
            console.log('应用用户信息到UI:', {
                qq: user.qq,
                nickname: user.nickname,
                signature: user.signature,
                avatar: !!user.avatar
            });
            
            userInfoApplied = true; // 标记已经应用了用户信息
            
            // 更新昵称
            const nicknameEl = document.querySelector('.nickname');
            if (nicknameEl) {
                nicknameEl.textContent = user.nickname || `用户${user.qq}`;
            }
            
            // 更新QQ号
            const qqNumberEl = document.getElementById('profile-qq');
            if (qqNumberEl) {
                qqNumberEl.textContent = user.qq;
            }
            
            // 更新签名
            const signatureEl = document.getElementById('signature-text');
            if (signatureEl) {
                signatureEl.textContent = user.signature || '这个人很懒，什么都没留下';
            }
            
            // 更新头像
            const avatarEl = document.getElementById('main-avatar-img');
            if (avatarEl && user.avatar) {
                // 预加载图片，避免加载过程中闪烁
                const tempImg = new Image();
                tempImg.onload = function() {
                avatarEl.src = user.avatar;
                };
                tempImg.src = user.avatar;
            }
            
            // 更新资料卡信息
            const profileName = document.getElementById('profile-name');
            if (profileName) {
                profileName.textContent = user.nickname || `用户${user.qq}`;
            }
            
            const profileSignature = document.getElementById('profile-signature');
            if (profileSignature) {
                profileSignature.textContent = user.signature || '这个人很懒，什么都没留下';
            }
            
            const profileAvatar = document.getElementById('profile-avatar');
            if (profileAvatar && user.avatar) {
                profileAvatar.src = user.avatar;
            }
            
            // 更新状态
            if (user.status && typeof setStatusDisplay === 'function') {
                setStatusDisplay(user.status);
            }
            
            // 更新好友列表 - 确保在收到用户信息后立即更新好友列表
            console.log('用户信息应用完成，立即更新好友列表');
            if (user.qq && typeof updateFriendsList === 'function') {
                console.log('调用updateFriendsList更新好友列表');
                updateFriendsList(user.qq);
            } else {
                console.error('无法更新好友列表:', {
                    有用户QQ: !!user.qq,
                    更新函数存在: typeof updateFriendsList === 'function'
                });
            }
        }
        
        // 保存用户信息到本地存储
        function saveUserToLocalStorage(user) {
            if (user && user.qq) {
                try {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    console.log('用户信息已保存到本地存储');
                } catch (error) {
                    console.error('保存用户信息到本地存储失败:', error);
                }
            }
        }
        
        // 监听从主进程发来的用户信息
        window.electronAPI.onUserInfo((user) => {
            console.log('从主进程收到用户信息:', user);
            window.currentUser = user;
            applyUserInfoToUI(user);
            saveUserToLocalStorage(user);
        });
        
        // 全局函数用于显示资料卡，方便调试
        function showProfileCard() {
            console.log('----------- showProfileCard 开始 -----------');
            
            // 1. 获取需要的DOM元素
            const profileCard = document.getElementById('profile-card');
            const profileAvatar = document.getElementById('profile-avatar');
            const profileName = document.getElementById('profile-name');
            const profileQQ = document.getElementById('profile-qq');
            const profileSignature = document.getElementById('profile-signature');
            
            // 2. 检查DOM元素是否存在
            if (!profileCard || !profileAvatar || !profileName || !profileQQ || !profileSignature) {
                console.error('资料卡元素不完整:', {
                    profileCard: !!profileCard,
                    profileAvatar: !!profileAvatar,
                    profileName: !!profileName,
                    profileQQ: !!profileQQ,
                    profileSignature: !!profileSignature
                });
                alert('资料卡组件加载失败!');
                return;
            }
            
            // 3. 获取全局用户信息
            let userData = null;
            
            // 打印localStorage中所有的键值对，用于调试
            console.log('localStorage内容:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    const value = localStorage.getItem(key);
                    console.log(`- ${key}: ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}`);
                } catch (e) {
                    console.log(`- ${key}: [无法读取]`);
                }
            }
            
            // 首先检查全局变量
            if (window.currentUser && window.currentUser.qq) {
                console.log('使用全局变量中的用户信息');
                userData = window.currentUser;
            } else {
                // 尝试从localStorage获取
                try {
                    const savedUser = localStorage.getItem('currentUser');
                    console.log('从localStorage读取:', savedUser ? '有数据' : '无数据');
                    
                    if (savedUser) {
                        userData = JSON.parse(savedUser);
                        console.log('解析localStorage数据成功:', userData);
                        window.currentUser = userData; // 恢复到全局变量
                    }
                } catch (error) {
                    console.error('解析localStorage数据失败:', error);
                }
            }
            
            // 4. 检查用户信息是否存在
            if (!userData || !userData.qq) {
                console.error('用户信息不存在或无效:', userData);
                
                // 查看localStorage中是否有其他可能的用户信息
                try {
                    const rememberedUser = localStorage.getItem('rememberedUser');
                    if (rememberedUser) {
                        const user = JSON.parse(rememberedUser);
                        console.log('找到rememberedUser:', user);
                        if (user && user.qq) {
                            userData = user;
                            window.currentUser = userData;
                            console.log('使用rememberedUser作为备选');
                            // 同时保存到正确的键
                            localStorage.setItem('currentUser', JSON.stringify(user));
                        }
                    }
                } catch (e) {
                    console.error('检查rememberedUser失败:', e);
                }
                
                if (!userData || !userData.qq) {
                    alert('未找到用户信息，请确保已登录');
                    return;
                }
            }
            
            // 5. 更新资料卡显示
            console.log('准备更新资料卡:', userData);
            profileCard.style.display = 'block';
            profileAvatar.src = userData.avatar || 'assets/logo.png';
            profileName.textContent = userData.nickname || `用户${userData.qq}`;
            profileQQ.textContent = userData.qq || '------';
            profileSignature.textContent = userData.signature || '这个人很懒，什么都没留下';
            
            console.log('资料卡显示成功');
            console.log('----------- showProfileCard 结束 -----------');
        }
        
        // 全局函数用于处理资料卡保存
        function handleProfileSave() {
            console.log('通过onclick属性触发保存');
            const currentUser = window.currentUser;
            if (!currentUser) {
                // 尝试从本地存储恢复用户信息
                if (!tryLoadUserFromLocalStorage()) {
                    alert('未找到用户信息，请重新登录');
                    return;
                }
            }
            
            const profileName = document.getElementById('profile-name');
            const profileSignature = document.getElementById('profile-signature');
            const profileAvatar = document.getElementById('profile-avatar');
            const nickname = profileName.textContent;
            const signature = profileSignature.textContent;
            const avatar = profileAvatar.src;
            
            console.log('保存用户资料:', { qq: window.currentUser.qq, nickname, signature });
            
            // 更新主界面显示
            document.querySelector('.nickname').textContent = nickname;
            document.getElementById('signature-text').textContent = signature;
            document.getElementById('main-avatar-img').src = avatar;
            
            // 保存到服务器
            window.electronAPI.updateUserProfile(window.currentUser.qq, nickname, signature, avatar)
                .then(result => {
                    console.log('保存结果:', result);
                    if (result && result.success) {
                        // 更新本地数据
                        window.currentUser.nickname = nickname;
                        window.currentUser.signature = signature;
                        window.currentUser.avatar = avatar;
                        
                        // 同时更新本地存储
                        saveUserToLocalStorage(window.currentUser);
                        
                        // 关闭资料卡
                        document.getElementById('profile-card').style.display = 'none';
                        
                        // 提示成功
                        alert('个人资料已更新');
                    } else {
                        alert('更新失败：' + (result?.error || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('保存出错:', error);
                    alert('保存失败，请稍后再试');
                });
        }
        
        // 告知主进程页面已准备好接收数据
        document.addEventListener('DOMContentLoaded', function() {
            console.log('----------- DOMContentLoaded 事件触发 -----------');
            
            // 先尝试从本地存储加载，但不强制更新UI
            tryLoadUserFromLocalStorage();
            // 通知主进程页面已准备好
            window.electronAPI.mainPageReady();

            // 确保尝试从本地存储恢复用户信息
            let userLoaded = false;
            if (!window.currentUser) {
                userLoaded = tryLoadUserFromLocalStorage();
            }
            
            console.log('本地存储恢复结果:', userLoaded ? '成功' : '失败');
            
            // 如果成功加载用户信息，立即获取并显示好友列表
            if (userLoaded && window.currentUser && window.currentUser.qq) {
                console.log('用户信息加载成功，初始化好友列表:', window.currentUser.qq);
                updateFriendsList(window.currentUser.qq);
            } else {
                console.log('用户信息加载失败，暂不初始化好友列表');
            }

            // 如果加载失败，不要自动登录 - 主界面不应该再触发登录
            // 移除以下自动登录代码块，避免循环登录
            /*
            if (!userLoaded) {
                // 读取rememberedUser中的登录信息，进行登录
                try {
                    const rememberedUserStr = localStorage.getItem('rememberedUser');
                    if (rememberedUserStr) {
                        const rememberedUser = JSON.parse(rememberedUserStr);
                        if (rememberedUser && rememberedUser.username && rememberedUser.password) {
                            console.log('尝试使用记住的用户信息自动登录');
                            window.electronAPI.login(rememberedUser.username, rememberedUser.password);
                        }
                    }
                } catch (error) {
                    console.error('处理自动登录失败:', error);
                }
            }
            */

            let currentUser = window.currentUser || null;
            
            // 初始化DOM元素引用
            const avatarImg = document.getElementById('main-avatar-img');
            const profileCard = document.getElementById('profile-card');
            const profileAvatar = document.getElementById('profile-avatar');
            const profileName = document.getElementById('profile-name');
            const profileQQ = document.getElementById('profile-qq');
            const profileSignature = document.getElementById('profile-signature');
            const nicknameInput = document.getElementById('nickname-input');
            const signatureInput = document.getElementById('signature-input');
            const profileSave = document.getElementById('profile-save');
            const profileCancel = document.getElementById('profile-cancel');
            
            // 添加声音事件监听
            window.electronAPI.onFriendRequest(() => {
                console.log('收到新的好友请求');
                // 此事件已经在主进程中播放了声音
            });
            
            window.electronAPI.onFriendOnline((friendQq) => {
                console.log('好友上线:', friendQq);
                // 播放好友上线提示音
                window.electronAPI.playSound('上线提示音');
            });
            
            window.electronAPI.onMessageReceived((sender) => {
                console.log('收到来自用户的消息:', sender);
                // 播放消息提示音
                window.electronAPI.playSound('信息提示音');
            });
            
            // 如果存在恢复的用户信息，立即更新UI
            if (window.currentUser) {
                const user = window.currentUser;
                // 更新UI显示用户信息
                document.querySelector('.nickname').textContent = user.nickname || `用户${user.qq}`;
                if (document.getElementById('qq-number')) {
                    document.getElementById('qq-number').textContent = user.qq;
                }
                
                // 更新个性签名，确保存在
                const signatureEl = document.getElementById('signature-text');
                if (signatureEl) {
                    signatureEl.textContent = user.signature || '这个人很懒，什么都没留下';
                }
                
                // 更新头像（如果有）
                if (user.avatar && avatarImg) {
                    avatarImg.src = user.avatar;
                }
                
                // 设置状态显示
                if (user.status && typeof setStatusDisplay === 'function') {
                    setStatusDisplay(user.status);
                }
                
                // 更新好友列表
                updateFriendsList(user.qq);
            }
            
            let isEditingNickname = false;
            let isEditingSignature = false;
            
            // 调试信息
            console.log('DOM元素初始化状态:');
            console.log('- 头像元素:', avatarImg);
            console.log('- 资料卡:', profileCard);
            console.log('- 保存按钮:', profileSave);

            // 点击头像显示资料卡
            if (avatarImg) {
                console.log('为头像添加点击事件');
                avatarImg.addEventListener('click', () => {
                    console.log('点击头像，显示资料卡');
                    if (profileCard) {
                        profileCard.style.display = 'block';
                        
                        // 更新资料卡信息
                        if (currentUser) {
                            console.log('更新资料卡信息:', currentUser);
                            profileAvatar.src = currentUser.avatar || 'assets/logo.png';
                            profileName.textContent = currentUser.nickname || `用户${currentUser.qq}`;
                            profileQQ.textContent = currentUser.qq || '------';
                            profileSignature.textContent = currentUser.signature || '这个人很懒，什么都没留下';
                        } else {
                            console.error('当前用户信息不存在');
                        }
                    } else {
                        console.error('资料卡元素不存在');
                    }
                });
            } else {
                console.error('头像元素不存在!');
            }
            
            // 点击资料卡头像更换头像
            if (profileAvatar) {
                profileAvatar.addEventListener('click', async (e) => {
                    e.stopPropagation(); // 阻止事件冒泡
                    console.log('点击资料卡头像');
                    try {
                        const filePath = await window.electronAPI.openFileDialog();
                        console.log('选择的文件路径:', filePath);
                        if (filePath) {
                            profileAvatar.src = filePath;
                            avatarImg.src = filePath; // 同时更新主界面头像
                        }
                    } catch (error) {
                        console.error('选择头像时发生错误:', error);
                    }
                });
            }
            
            // 点击昵称编辑
            if (profileName) {
                profileName.addEventListener('click', () => {
                    if (!isEditingNickname) {
                        isEditingNickname = true;
                        nicknameInput.value = profileName.textContent;
                        nicknameInput.style.display = 'block';
                        profileName.style.display = 'none';
                        nicknameInput.focus();
                    }
                });
            }
            
            // 点击个性签名编辑
            if (profileSignature) {
                profileSignature.addEventListener('click', () => {
                    if (!isEditingSignature) {
                        isEditingSignature = true;
                        signatureInput.value = profileSignature.textContent;
                        signatureInput.style.display = 'block';
                        profileSignature.style.display = 'none';
                        signatureInput.focus();
                    }
                });
            }
            
            // 昵称输入完成
            if (nicknameInput) {
                nicknameInput.addEventListener('blur', () => {
                    if (isEditingNickname && nicknameInput.value.trim()) {
                        profileName.textContent = nicknameInput.value.trim();
                    }
                    nicknameInput.style.display = 'none';
                    profileName.style.display = 'block';
                    isEditingNickname = false;
                });
                
                // 按Enter键完成输入
                nicknameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') nicknameInput.blur();
                });
            }
            
            // 个性签名输入完成
            if (signatureInput) {
                signatureInput.addEventListener('blur', () => {
                    if (isEditingSignature && signatureInput.value.trim()) {
                        profileSignature.textContent = signatureInput.value.trim();
                    }
                    signatureInput.style.display = 'none';
                    profileSignature.style.display = 'block';
                    isEditingSignature = false;
                });
                
                // 按Enter键完成输入
                signatureInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') signatureInput.blur();
                });
            }
            
            // 点击取消按钮
            if (profileCancel) {
                profileCancel.addEventListener('click', () => {
                    console.log('点击取消按钮');
                    profileCard.style.display = 'none';
                });
            }
            
            // 点击其他区域关闭资料卡
            document.addEventListener('click', (e) => {
                // 检查是否是保存按钮，如果是则不处理（让保存按钮的事件处理程序处理）
                if (e.target === profileSave || e.target === profileCancel || e.target === avatarImg || 
                    e.target === profileAvatar || e.target === profileName || e.target === profileSignature) {
                    return;
                }
                
                if (profileCard && profileCard.style.display === 'block' && 
                    !profileCard.contains(e.target)) {
                    console.log('点击了外部区域，关闭资料卡');
                    profileCard.style.display = 'none';
                }
            });
            
            // 添加测试事件监听器，验证事件系统是否正常
            if (profileSave) {
                console.log('正在为保存按钮添加点击事件监听器');
                // 只使用一种事件监听方式，避免重复触发
                profileSave.addEventListener('click', () => {
                    console.log('保存按钮被点击 - 测试监听器');
                    handleProfileSave();
                });
            } else {
                console.error('未找到保存按钮元素!');
            }

            // Remove the old search input logic for adding friends
            const searchInput = document.querySelector('.search-bar input');
            searchInput.placeholder = "搜索我的好友...";
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    // Implement local friend search here if needed
                    alert('正在搜索本地好友: ' + searchInput.value);
                }
            });

            const addFriendBtn = document.getElementById('add-friend-btn');
            if (addFriendBtn) {
                addFriendBtn.addEventListener('click', () => {
                   window.electronAPI.openAddFriendWindow();
                });
            }

            const friendRequestBadge = document.getElementById('friend-request-badge');
            if (friendRequestBadge) {
                window.electronAPI.onFriendRequestCount((count) => {
                    friendRequestBadge.textContent = count;
                    friendRequestBadge.style.display = count > 0 ? 'flex' : 'none';
                });
            }

            const friendListContainer = document.querySelector('.friend-list');
            if (!friendListContainer) return;

            // 全局friendGroups数组，确保声明在正确的作用域
            let friendGroups = [];

            function renderFriendList() {
                console.log('开始渲染好友列表，当前好友组数据:', friendGroups);
                
                // 检查DOM元素
                if (!friendListContainer) {
                    friendListContainer = document.querySelector('.friend-list');
                    if (!friendListContainer) {
                        console.error('无法找到好友列表容器元素');
                        return;
                    }
                }
                
                // 清空容器
                friendListContainer.innerHTML = '';
                console.log(`清空好友列表容器完成，准备渲染${friendGroups.length}个分组`);
                
                // 添加调试信息
                if (friendGroups.length === 0) {
                    console.warn('没有好友组数据可渲染');
                    // 添加空状态提示
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-friend-list';
                    emptyState.style.padding = '20px';
                    emptyState.style.textAlign = 'center';
                    emptyState.style.color = '#999';
                    emptyState.textContent = '好友列表为空，请添加好友';
                    friendListContainer.appendChild(emptyState);
                    return;
                }
                
                // 为了调试，显示整个好友分组数据
                console.log('完整的好友分组数据:', JSON.stringify(friendGroups, null, 2));
                
                friendGroups.forEach((groupData, groupIndex) => {
                    console.log(`渲染第${groupIndex+1}个分组: ${groupData.name}，包含${groupData.friends.length}个好友`);
                    
                    const groupDiv = document.createElement('div');
                    groupDiv.className = `friend-group ${groupData.open ? 'open' : ''}`;
                    
                    // 确保分组是可见的
                    groupDiv.style.display = 'block';
                    
                    const header = document.createElement('div');
                    header.className = 'group-header';
                    header.innerHTML = `
                        <div class="group-arrow"></div>
                        <span>${groupData.name} [${groupData.online}/${groupData.total}]</span>
                    `;

                    const friendsContainer = document.createElement('div');
                    friendsContainer.className = 'friends-container';
                    
                    // 确保好友容器可见
                    if (groupData.open) {
                        friendsContainer.style.display = 'block';
                    } else {
                        friendsContainer.style.display = 'none';
                    }

                    if (!groupData.friends || !Array.isArray(groupData.friends)) {
                        console.error(`分组 ${groupData.name} 的好友列表不是数组:`, groupData.friends);
                        groupData.friends = [];
                    }

                    groupData.friends.forEach((friendData, friendIndex) => {
                        if (!friendData) {
                            console.error(`好友数据为空: 分组=${groupData.name}, 索引=${friendIndex}`);
                            return;
                        }
                        
                        console.log(`渲染好友: QQ=${friendData.qq}, 昵称=${friendData.nickname}`);

                        const friendDiv = document.createElement('div');
                        friendDiv.className = `friend-item ${friendData.online ? '' : 'offline'}`;
                        friendDiv.id = `friend-item-${friendData.qq}`;
                        
                        // 确保好友项可见
                        friendDiv.style.display = 'flex';

                        let friendHtml = `
                            <div class="friend-avatar-wrapper">
                                <img src="${friendData.avatar || 'assets/logo.png'}" alt="Avatar" onerror="this.src='assets/logo.png'">
                                ${friendData.online ? '<span class="friend-status-icon"></span>' : ''}
                            </div>
                            <div class="friend-details">
                                <span class="friend-name">${friendData.nickname || '未知用户'}</span>
                                <span class="friend-signature">${friendData.signature || '这个人很懒，什么都没留下'}</span>
                            </div>
                        `;

                        if (groupData.isRequestGroup) {
                            friendHtml += `
                                <div class="request-actions">
                                    <button class="accept-btn">同意</button>
                                    <button class="reject-btn">拒绝</button>
                                </div>
                            `;
                        }
                        
                        friendDiv.innerHTML = friendHtml;
                        friendsContainer.appendChild(friendDiv);
                        
                        if (groupData.isRequestGroup) {
                            friendDiv.querySelector('.accept-btn').addEventListener('click', async (e) => {
                                e.stopPropagation();
                                await window.electronAPI.acceptFriendRequest(currentUser.qq, friendData.qq);
                            });
                            friendDiv.querySelector('.reject-btn').addEventListener('click', async (e) => {
                                e.stopPropagation();
                                await window.electronAPI.rejectFriendRequest(currentUser.qq, friendData.qq);
                            });
                        } else {
                            friendDiv.addEventListener('click', () => {
                                alert(`将与 ${friendData.nickname} 开始聊天`);
                            });
                        }
                    });

                    groupDiv.appendChild(header);
                    groupDiv.appendChild(friendsContainer);
                    friendListContainer.appendChild(groupDiv);

                    header.addEventListener('click', () => {
                        groupDiv.classList.toggle('open');
                        // 更新可见性
                        const isOpen = groupDiv.classList.contains('open');
                        friendsContainer.style.display = isOpen ? 'block' : 'none';
                    });
                });
                
                console.log('好友列表渲染完成');
                
                // 确保样式正确应用
                setTimeout(() => {
                    const addedGroups = document.querySelectorAll('.friend-group');
                    console.log(`实际添加到DOM的分组数量: ${addedGroups.length}`);
                    addedGroups.forEach(group => {
                        console.log(`分组样式: display=${window.getComputedStyle(group).display}`);
                    });
                }, 100);
            }

            renderFriendList();

            // 添加好友请求处理逻辑
            window.electronAPI.onFriendRequestAccepted((newFriend) => {
                console.log('接受好友请求成功，新好友数据:', newFriend);
                
                try {
                    if (!newFriend || !newFriend.qq) {
                        console.error('接受好友请求成功，但新好友数据不完整:', newFriend);
                        return;
                    }
                    
                    const requestsGroup = friendGroups.find(g => g.isRequestGroup);
                    if (requestsGroup) {
                        console.log('找到请求组，从中移除已接受的好友请求');
                        requestsGroup.friends = requestsGroup.friends.filter(r => r.qq !== newFriend.qq);
                        requestsGroup.online--;
                        requestsGroup.total--;
                        
                        // 更新好友请求徽章数量
                        const requestCount = requestsGroup.friends.length;
                        const badge = document.getElementById('friend-request-badge');
                        if (badge) {
                            badge.textContent = requestCount;
                            badge.style.display = requestCount > 0 ? 'flex' : 'none';
                        }
                        
                        // 如果没有剩余请求，移除好友请求组
                        if (requestCount === 0) {
                            console.log('没有剩余好友请求，移除请求组');
                            friendGroups = friendGroups.filter(g => !g.isRequestGroup);
                        }
                    } else {
                        console.log('未找到好友请求组');
                    }

                    // 找到或创建好友分组
                    let friendsGroup = friendGroups.find(g => g.name === "我的好友");
                    if (!friendsGroup) {
                        console.log('未找到好友分组，创建新分组');
                        friendsGroup = { name: "我的好友", online: 0, total: 0, open: true, friends: [] };
                        friendGroups.push(friendsGroup);
                    }
                    
                    // 检查好友是否已存在
                    const existingFriend = friendsGroup.friends.find(f => f.qq === newFriend.qq);
                    if (existingFriend) {
                        console.log('好友已存在，不添加重复好友');
                    } else {
                        console.log('添加新好友到好友列表');
                        // 添加完整的好友信息
                        friendsGroup.friends.push({ 
                            ...newFriend, 
                            online: true,
                            signature: newFriend.signature || '这个人很懒，什么都没留下',
                            status: 'online'
                        });
                        friendsGroup.online++;
                        friendsGroup.total++;
                    }
                    
                    console.log('重新渲染好友列表');
                    console.log('当前好友分组数据:', JSON.stringify(friendGroups, null, 2));
                    
                    // 先渲染内存中的数据，然后再从服务器获取最新数据
                    renderFriendList();
                    
                    // 强制重新从服务器获取最新好友列表
                    setTimeout(() => {
                        if (window.currentUser && window.currentUser.qq) {
                            console.log('从服务器刷新好友列表');
                            updateFriendsList(window.currentUser.qq);
                        } else {
                            console.log('无法刷新好友列表，当前用户信息缺失');
                        }
                    }, 500); // 延迟半秒，确保服务器数据已更新
                } catch (error) {
                    console.error('处理好友请求接受事件时出错:', error);
                    // 出错时也尝试刷新好友列表
                    if (window.currentUser && window.currentUser.qq) {
                        updateFriendsList(window.currentUser.qq);
                    }
                }
            });

            window.electronAPI.onFriendRequestRejected((requesterQq) => {
                const requestsGroup = friendGroups.find(g => g.isRequestGroup);
                if (requestsGroup) {
                    requestsGroup.friends = requestsGroup.friends.filter(r => r.qq !== requesterQq);
                    requestsGroup.online--;
                    requestsGroup.total--;
                    
                    // 更新好友请求徽章数量
                    const requestCount = requestsGroup.friends.length;
                    const badge = document.getElementById('friend-request-badge');
                    if (badge) {
                        badge.textContent = requestCount;
                        badge.style.display = requestCount > 0 ? 'flex' : 'none';
                    }
                    
                    // 如果没有剩余请求，移除好友请求组
                    if (requestCount === 0) {
                        friendGroups = friendGroups.filter(g => !g.isRequestGroup);
                    }
                    
                    renderFriendList();
                }
            });
            
            // 个性签名编辑功能
            const signatureText = document.getElementById('signature-text');
            const editSignature = document.querySelector('.user-signature');
            const mainMenuBtn = document.getElementById('main-menu-btn');
            const mainMenuPopup = document.getElementById('main-menu-popup');
            const switchAccountBtn = document.getElementById('switch-account-btn');
            
            // 初始化菜单功能
            if (mainMenuBtn && mainMenuPopup) {
                mainMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    mainMenuPopup.style.display = mainMenuPopup.style.display === 'block' ? 'none' : 'block';
                });

                switchAccountBtn.addEventListener('click', () => {
                    window.electronAPI.switchAccount();
                });
                
                // 添加测试声音的点击事件
                const testSoundBtn = document.getElementById('test-sound-btn');
                if (testSoundBtn) {
                    testSoundBtn.addEventListener('click', () => {
                        // 创建测试声音的弹出菜单
                        const testSoundMenu = document.createElement('div');
                        testSoundMenu.className = 'test-sound-menu';
                        testSoundMenu.style.position = 'absolute';
                        testSoundMenu.style.left = (mainMenuPopup.offsetLeft + mainMenuPopup.offsetWidth) + 'px';
                        testSoundMenu.style.top = mainMenuPopup.offsetTop + 'px';
                        testSoundMenu.style.backgroundColor = '#fff';
                        testSoundMenu.style.border = '1px solid #ccc';
                        testSoundMenu.style.borderRadius = '3px';
                        testSoundMenu.style.padding = '5px';
                        testSoundMenu.style.zIndex = '1000';
                        testSoundMenu.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                        
                        // 添加三个声音选项
                        const sounds = ['上线提示音', '信息提示音', '加好友提示'];
                        sounds.forEach(sound => {
                            const item = document.createElement('div');
                            item.textContent = sound;
                            item.style.padding = '5px 10px';
                            item.style.cursor = 'pointer';
                            item.style.borderRadius = '3px';
                            
                            item.addEventListener('mouseover', () => {
                                item.style.backgroundColor = '#f0f0f0';
                            });
                            
                            item.addEventListener('mouseout', () => {
                                item.style.backgroundColor = 'transparent';
                            });
                            
                            item.addEventListener('click', () => {
                                window.electronAPI.playSound(sound);
                                testSoundMenu.remove(); // 点击后移除菜单
                                mainMenuPopup.style.display = 'none'; // 同时隐藏主菜单
                            });
                            
                            testSoundMenu.appendChild(item);
                        });
                        
                        document.body.appendChild(testSoundMenu);
                        
                        // 点击其他区域关闭测试声音菜单
                        const closeTestSoundMenu = (e) => {
                            if (!testSoundMenu.contains(e.target) && e.target !== testSoundBtn) {
                                testSoundMenu.remove();
                                document.removeEventListener('click', closeTestSoundMenu);
                            }
                        };
                        
                        // 延迟一下添加点击监听，防止立即触发
                        setTimeout(() => {
                            document.addEventListener('click', closeTestSoundMenu);
                        }, 10);
                    });
                }

                document.addEventListener('click', (e) => {
                    if (mainMenuPopup.style.display === 'block' && !mainMenuPopup.contains(e.target)) {
                        mainMenuPopup.style.display = 'none';
                    }
                    
                    // 隐藏状态菜单
                    if (statusMenuPopup.style.display === 'block' && !statusMenuPopup.contains(e.target) && e.target !== statusSelector) {
                        statusMenuPopup.style.display = 'none';
                    }
                });
            }
            
            // 状态选择器功能
            const statusIcon = document.getElementById('status-icon');
            const statusMenuPopup = document.getElementById('status-menu-popup');
            const statusTextSpan = document.querySelector('.status-text');
            
            if (statusIcon && statusMenuPopup) {
                console.log('状态图标事件已通过onclick属性设置');
                
                // 选择状态
                const statusItems = statusMenuPopup.querySelectorAll('li');
                statusItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const status = item.getAttribute('data-status');
                        const statusLabel = item.textContent.trim();
                        
                        // 更新状态图标
                        statusIcon.className = `status-icon ${status}`;
                        if (statusTextSpan) statusTextSpan.textContent = `[${statusLabel}]`;
                        
                        // 关闭菜单
                        statusMenuPopup.style.display = 'none';
                        
                        // 如果有currentUser，则更新服务器状态
                        if (window.currentUser && window.currentUser.qq) {
                            window.electronAPI.updateStatus(window.currentUser.qq, status)
                                .then(result => {
                                    console.log('状态更新结果:', result);
                                })
                                .catch(error => {
                                    console.error('更新状态失败:', error);
                                });
                        }
                    });
                });
                
                // 点击其他区域关闭状态菜单
                document.addEventListener('click', (e) => {
                    if (statusMenuPopup.style.display === 'block' && 
                        e.target !== statusIcon && 
                        !statusMenuPopup.contains(e.target)) {
                        statusMenuPopup.style.display = 'none';
                    }
                });
            } else {
                console.error('未找到状态图标或状态菜单元素');
            }
            
            if (signatureText && editSignature) {
                editSignature.addEventListener('click', () => {
                    const currentText = signatureText.textContent;
                    const newText = prompt('请输入新的个性签名', currentText);
                    if (newText && newText.trim() !== '') {
                        signatureText.textContent = newText;
                    }
                });
            }

            // 修改刷新按钮的事件监听器
            const refreshFriendsBtn = document.getElementById('refresh-friends-btn');
            if (refreshFriendsBtn) {
                refreshFriendsBtn.addEventListener('click', async function() {
                    console.log('手动刷新好友列表');
                    
                    // 添加旋转动画
                    refreshFriendsBtn.classList.add('rotating');
                    
                    try {
                        if (window.currentUser && window.currentUser.qq) {
                            await updateFriendsList(window.currentUser.qq);
                            // 显示刷新成功的提示
                            showToast('好友列表刷新成功');
                        } else {
                            console.error('刷新失败：用户未登录');
                        }
                    } catch (error) {
                        console.error('刷新好友列表出错:', error);
                        showToast('刷新失败，请稍后重试', 'error');
                    } finally {
                        // 动画结束后移除旋转类
                        setTimeout(() => {
                            refreshFriendsBtn.classList.remove('rotating');
                        }, 500);
                    }
                });
            }

            // 添加一个简单的Toast提示函数
            function showToast(message, type = 'success') {
                // 创建toast元素
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                // 添加样式
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.padding = '10px 20px';
                toast.style.borderRadius = '4px';
                toast.style.color = 'white';
                toast.style.zIndex = '9999';
                toast.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                
                // 根据类型设置背景色
                if (type === 'success') {
                    toast.style.backgroundColor = '#4CAF50';
                } else if (type === 'error') {
                    toast.style.backgroundColor = '#f44336';
                } else {
                    toast.style.backgroundColor = '#2196F3';
                }
                
                // 添加到文档
                document.body.appendChild(toast);
                
                // 3秒后移除
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.5s ease';
                    
                    // 完全隐藏后移除元素
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 500);
                }, 3000);
            }
        });

        document.getElementById('minimize-btn').addEventListener('click', () => window.electronAPI.minimizeWindow());
        document.getElementById('maximize-btn').addEventListener('click', () => window.electronAPI.maximizeWindow());
        document.getElementById('close-btn').addEventListener('click', () => window.electronAPI.closeWindow());

        // On page load, get and set saved avatar
        window.electronAPI.getAvatarPath().then(path => {
            if (path) {
                avatarImg.src = path;
            }
        });

        // 更新好友列表
        async function updateFriendsList(qq) {
            if (!qq) {
                console.error('缺少QQ号，无法获取好友列表');
                return;
            }
            
            console.log(`开始获取好友列表 - QQ: ${qq}`);
            
            try {
                const friendsResponse = await window.electronAPI.getFriends(qq);
                console.log('获取好友列表API响应:', friendsResponse);
                
                if (friendsResponse.success) {
                    // 清空原有好友组数据
                    friendGroups = [];
                    
                    // 检查好友数据
                    if (!friendsResponse.friends || !Array.isArray(friendsResponse.friends)) {
                        console.error('API返回的好友数据无效:', friendsResponse.friends);
                        friendsResponse.friends = [];
                    }
                    
                    console.log(`收到好友数据: ${friendsResponse.friends.length}个好友`);
                    
                    // 渲染好友列表
                    const friendData = friendsResponse.friends.map(f => {
                        // 确保每个好友对象包含所有必要的字段
                        const friendWithDefaults = { 
                            ...f, 
                            signature: f.signature || '这个人很懒，什么都没留下',
                            status: f.status || 'online',
                            online: f.status === 'online' || f.status === 'away' || f.status === 'busy'
                        };
                        
                        console.log(`处理好友: QQ=${f.qq}, 昵称=${f.nickname}, 在线=${friendWithDefaults.online}`);
                        return friendWithDefaults;
                    });
                    
                    // 如果有好友数据，添加好友分组
                    friendGroups.push({
                        name: "我的好友",
                        online: friendData.filter(f => f.online).length,
                        total: friendData.length,
                        open: true,
                        friends: friendData
                    });
                    
                    console.log(`创建好友分组: 在线=${friendGroups[0].online}, 总数=${friendGroups[0].total}`);
                    
                    // 检查好友请求数据
                    if (!friendsResponse.requests) {
                        console.log('API返回的好友请求数据为空');
                        friendsResponse.requests = [];
                    }
                    
                    // 渲染好友请求
                    if (friendsResponse.requests && friendsResponse.requests.length > 0) {
                        console.log(`收到好友请求数据: ${friendsResponse.requests.length}个请求`);
                        
                        const requestsData = friendsResponse.requests.map(r => ({ 
                            ...r, 
                            online: true,
                            signature: r.signature || '这个人很懒，什么都没留下'
                        }));
                        
                        friendGroups.unshift({ // 添加到列表开头
                            name: "好友请求",
                            online: requestsData.length,
                            total: requestsData.length,
                            open: true,
                            isRequestGroup: true, // 自定义标记
                            friends: requestsData 
                        });
                        
                        // 更新好友请求徽章数量
                        const requestCount = requestsData.length;
                        const badge = document.getElementById('friend-request-badge');
                        if (badge) {
                            badge.textContent = requestCount;
                            badge.style.display = requestCount > 0 ? 'flex' : 'none';
                        }
                    } else {
                        // 如果没有好友请求，隐藏徽章
                        const badge = document.getElementById('friend-request-badge');
                        if (badge) {
                            badge.style.display = 'none';
                        }
                    }
                    
                    console.log('好友数据处理完成，准备渲染好友列表');
                    renderFriendList();
                } else {
                    console.error('获取好友列表失败:', friendsResponse.message);
                }
            } catch (error) {
                console.error('获取好友列表出错:', error);
            }
        }

        // 设置状态显示
        function setStatusDisplay(status) {
            // 更新头像旁边的状态图标
            const statusIcon = document.getElementById('status-icon');
            if (statusIcon) {
                // 首先移除所有状态类
                statusIcon.classList.remove('online', 'away', 'busy', 'invisible');
                // 然后添加当前状态类
                statusIcon.classList.add(status);
            }
            
            // 更新状态文本
            const statusText = document.querySelector('.status-text');
            if (statusText) {
                let displayText = '在线';
                switch (status) {
                    case 'away': displayText = '离开'; break;
                    case 'busy': displayText = '忙碌'; break;
                    case 'invisible': displayText = '隐身'; break;
            }
                
                statusText.textContent = `[${displayText}]`;
            }
        }
    </script>
</body>
</html> 